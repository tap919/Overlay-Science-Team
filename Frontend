import React, { useState, useEffect } from 'react';
import { Upload, Play, FileText, Beaker, Atom, BookOpen, Image, TrendingUp, Clock, CheckCircle, AlertCircle, Loader } from 'lucide-react';

const ScientificPipeline = () => {
  const [studies, setStudies] = useState([]);
  const [activeStudy, setActiveStudy] = useState(null);
  const [dragging, setDragging] = useState(false);
  const [deliverables, setDeliverables] = useState([]);

  const pipelineStages = [
    { id: 'ingest', name: 'Source Ingestion', icon: Upload, agent: 'Source Ingester' },
    { id: 'quantum', name: 'Quantum Chaos', icon: Atom, agent: 'Quantum Runner', tool: 'GLCCE' },
    { id: 'biotech', name: 'Biotech Simulation', icon: Beaker, agent: 'Biotech Simulator', tool: 'Digital Lab' },
    { id: 'insights', name: 'Insight Synthesis', icon: TrendingUp, agent: 'Analytics Compiler', tool: 'DataLite' },
    { id: 'writing', name: 'Paper & Book Writing', icon: BookOpen, agent: 'Writer Agent', tool: 'Book Lab' },
    { id: 'metaphor', name: 'Metaphor Enhancement', icon: Image, agent: 'Metaphor Agent', tool: 'Comic Engine' }
  ];

  const handleDrop = (e) => {
    e.preventDefault();
    setDragging(false);
    
    const files = Array.from(e.dataTransfer.files);
    const studyId = `study_${Date.now()}`;
    const timestamp = new Date().toLocaleString();
    
    const newStudy = {
      id: studyId,
      name: `Study ${studies.length + 1}`,
      timestamp,
      sources: files.map(f => f.name),
      status: 'processing',
      currentStage: 0,
      progress: {},
      outputs: []
    };
    
    setStudies(prev => [newStudy, ...prev]);
    setActiveStudy(studyId);
    runPipeline(studyId);
  };

  const runPipeline = (studyId) => {
    let currentStage = 0;
    
    const processStage = () => {
      if (currentStage >= pipelineStages.length) {
        // Pipeline complete
        setStudies(prev => prev.map(s => 
          s.id === studyId 
            ? { ...s, status: 'complete', currentStage: -1 }
            : s
        ));
        generateDeliverables(studyId);
        return;
      }

      const stage = pipelineStages[currentStage];
      
      setStudies(prev => prev.map(s => 
        s.id === studyId 
          ? { 
              ...s, 
              currentStage,
              progress: { 
                ...s.progress, 
                [stage.id]: { status: 'running', percent: 0 } 
              }
            }
          : s
      ));

      // Simulate stage progress
      let percent = 0;
      const progressInterval = setInterval(() => {
        percent += Math.random() * 15;
        if (percent >= 100) {
          percent = 100;
          clearInterval(progressInterval);
          
          setStudies(prev => prev.map(s => 
            s.id === studyId 
              ? { 
                  ...s, 
                  progress: { 
                    ...s.progress, 
                    [stage.id]: { status: 'complete', percent: 100 } 
                  }
                }
              : s
          ));

          currentStage++;
          setTimeout(() => processStage(), 500);
        } else {
          setStudies(prev => prev.map(s => 
            s.id === studyId 
              ? { 
                  ...s, 
                  progress: { 
                    ...s.progress, 
                    [stage.id]: { status: 'running', percent: Math.floor(percent) } 
                  }
                }
              : s
          ));
        }
      }, 300);
    };

    processStage();
  };

  const generateDeliverables = (studyId) => {
    const study = studies.find(s => s.id === studyId);
    const timestamp = new Date().toLocaleString();
    
    const newDeliverables = [
      {
        id: `${studyId}_paper1`,
        studyId,
        type: 'paper',
        title: 'Quantum Chaos Analysis of Protein Folding Dynamics',
        timestamp,
        pages: 12,
        citations: 23
      },
      {
        id: `${studyId}_paper2`,
        studyId,
        type: 'paper',
        title: 'Biotech Simulation Results: Novel Pathways',
        timestamp,
        pages: 8,
        citations: 15
      },
      {
        id: `${studyId}_book`,
        studyId,
        type: 'book_chapter',
        title: 'Chapter 3: Chaos Theory in Biological Systems',
        timestamp,
        pages: 24,
        metaphors: 8
      },
      {
        id: `${studyId}_analytics`,
        studyId,
        type: 'analytics',
        title: 'Convergence Analysis Dashboard',
        timestamp,
        charts: 12,
        datasets: 4
      }
    ];

    setDeliverables(prev => [...newDeliverables, ...prev]);
    
    setStudies(prev => prev.map(s => 
      s.id === studyId 
        ? { ...s, outputs: newDeliverables }
        : s
    ));
  };

  return (
    <div className="w-full h-screen bg-slate-900 text-white flex flex-col">
      {/* Header */}
      <div className="bg-slate-800 border-b border-slate-700 px-6 py-4">
        <h1 className="text-2xl font-bold">Scientific Production Pipeline</h1>
        <p className="text-slate-400 text-sm mt-1">
          Drop sources → Get papers, books, and analytics by lunch
        </p>
      </div>

      <div className="flex-1 flex gap-6 p-6 overflow-hidden">
        {/* Left: Drop Zone & Active Studies */}
        <div className="w-96 flex flex-col gap-6">
          {/* Drop Zone */}
          <div
            onDrop={handleDrop}
            onDragOver={(e) => { e.preventDefault(); setDragging(true); }}
            onDragLeave={() => setDragging(false)}
            className={`border-2 border-dashed rounded-lg p-8 transition-all ${
              dragging 
                ? 'border-blue-500 bg-blue-500/10' 
                : 'border-slate-600 hover:border-slate-500'
            }`}
          >
            <div className="text-center">
              <Upload className="w-12 h-12 mx-auto mb-4 opacity-50" />
              <h3 className="font-semibold mb-2">Drop Research Sources</h3>
              <p className="text-sm text-slate-400">
                Books, PDFs, datasets, research papers
              </p>
              <p className="text-xs text-slate-500 mt-2">
                Pipeline will automatically process through all stages
              </p>
            </div>
          </div>

          {/* Active Studies */}
          <div className="flex-1 bg-slate-800 rounded-lg p-4 overflow-hidden flex flex-col">
            <h3 className="font-semibold mb-4 flex items-center gap-2">
              <Clock className="w-5 h-5" />
              Active Studies ({studies.filter(s => s.status === 'processing').length})
            </h3>
            
            <div className="flex-1 overflow-y-auto space-y-3">
              {studies.map(study => (
                <div
                  key={study.id}
                  onClick={() => setActiveStudy(study.id)}
                  className={`p-3 rounded-lg cursor-pointer transition-all ${
                    activeStudy === study.id 
                      ? 'bg-slate-700 ring-2 ring-blue-500' 
                      : 'bg-slate-750 hover:bg-slate-700'
                  }`}
                >
                  <div className="flex items-start justify-between mb-2">
                    <div>
                      <h4 className="font-semibold text-sm">{study.name}</h4>
                      <p className="text-xs text-slate-400">{study.timestamp}</p>
                    </div>
                    {study.status === 'processing' && (
                      <Loader className="w-4 h-4 animate-spin text-blue-400" />
                    )}
                    {study.status === 'complete' && (
                      <CheckCircle className="w-4 h-4 text-green-400" />
                    )}
                  </div>
                  
                  <div className="text-xs text-slate-400">
                    Sources: {study.sources.length} files
                  </div>
                  
                  {study.outputs.length > 0 && (
                    <div className="mt-2 text-xs text-green-400">
                      ✓ {study.outputs.length} deliverables ready
                    </div>
                  )}
                </div>
              ))}
              
              {studies.length === 0 && (
                <div className="text-center text-slate-500 py-8">
                  No studies yet. Drop sources to begin.
                </div>
              )}
            </div>
          </div>
        </div>

        {/* Center: Pipeline Visualization */}
        <div className="flex-1 bg-slate-800 rounded-lg p-6 overflow-y-auto">
          <h3 className="font-semibold mb-6 text-lg">Pipeline Status</h3>
          
          {activeStudy ? (
            <div className="space-y-4">
              {pipelineStages.map((stage, idx) => {
                const study = studies.find(s => s.id === activeStudy);
                const stageProgress = study?.progress[stage.id];
                const isActive = study?.currentStage === idx;
                const isComplete = stageProgress?.status === 'complete';
                const isPending = !stageProgress;
                
                const Icon = stage.icon;
                
                return (
                  <div key={stage.id} className="relative">
                    {idx < pipelineStages.length - 1 && (
                      <div className={`absolute left-6 top-16 w-0.5 h-8 ${
                        isComplete ? 'bg-green-500' : 'bg-slate-700'
                      }`} />
                    )}
                    
                    <div className={`p-4 rounded-lg border-2 transition-all ${
                      isActive ? 'border-blue-500 bg-blue-500/10' :
                      isComplete ? 'border-green-500 bg-green-500/10' :
                      'border-slate-700'
                    }`}>
                      <div className="flex items-start gap-4">
                        <div className={`w-12 h-12 rounded-full flex items-center justify-center ${
                          isActive ? 'bg-blue-500' :
                          isComplete ? 'bg-green-500' :
                          'bg-slate-700'
                        }`}>
                          <Icon className="w-6 h-6" />
                        </div>
                        
                        <div className="flex-1">
                          <div className="flex items-start justify-between mb-2">
                            <div>
                              <h4 className="font-semibold">{stage.name}</h4>
                              <p className="text-xs text-slate-400">
                                Agent: {stage.agent}
                                {stage.tool && ` • Tool: ${stage.tool}`}
                              </p>
                            </div>
                            
                            {isComplete && (
                              <CheckCircle className="w-5 h-5 text-green-400" />
                            )}
                            {isActive && (
                              <Loader className="w-5 h-5 animate-spin text-blue-400" />
                            )}
                          </div>
                          
                          {stageProgress && (
                            <div className="mt-3">
                              <div className="flex justify-between text-xs mb-1">
                                <span className="text-slate-400">Progress</span>
                                <span className="text-slate-300">{stageProgress.percent}%</span>
                              </div>
                              <div className="w-full bg-slate-700 rounded-full h-2">
                                <div 
                                  className={`h-2 rounded-full transition-all ${
                                    isComplete ? 'bg-green-500' : 'bg-blue-500'
                                  }`}
                                  style={{ width: `${stageProgress.percent}%` }}
                                />
                              </div>
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}
            </div>
          ) : (
            <div className="text-center text-slate-500 py-16">
              Select a study to view pipeline status
            </div>
          )}
        </div>

        {/* Right: Deliverables */}
        <div className="w-96 bg-slate-800 rounded-lg p-4 flex flex-col">
          <h3 className="font-semibold mb-4 flex items-center gap-2">
            <FileText className="w-5 h-5" />
            Today's Deliverables ({deliverables.length})
          </h3>
          
          <div className="flex-1 overflow-y-auto space-y-3">
            {deliverables.map(item => {
              const typeConfig = {
                paper: { icon: FileText, color: 'blue', label: 'Research Paper' },
                book_chapter: { icon: BookOpen, color: 'purple', label: 'Book Chapter' },
                analytics: { icon: TrendingUp, color: 'green', label: 'Analytics' }
              };
              
              const config = typeConfig[item.type];
              const Icon = config.icon;
              
              return (
                <div key={item.id} className="bg-slate-900 p-4 rounded-lg hover:bg-slate-750 transition-colors cursor-pointer">
                  <div className="flex items-start gap-3">
                    <div className={`w-10 h-10 rounded-lg bg-${config.color}-500/20 flex items-center justify-center flex-shrink-0`}>
                      <Icon className={`w-5 h-5 text-${config.color}-400`} />
                    </div>
                    
                    <div className="flex-1 min-w-0">
                      <div className={`text-xs text-${config.color}-400 mb-1`}>
                        {config.label}
                      </div>
                      <h4 className="font-semibold text-sm mb-2 line-clamp-2">
                        {item.title}
                      </h4>
                      
                      <div className="text-xs text-slate-400 space-y-1">
                        <div>{item.timestamp}</div>
                        {item.pages && <div>{item.pages} pages</div>}
                        {item.citations && <div>{item.citations} citations</div>}
                        {item.metaphors && <div>{item.metaphors} metaphors</div>}
                        {item.charts && <div>{item.charts} charts</div>}
                      </div>
                    </div>
                  </div>
                  
                  <div className="mt-3 flex gap-2">
                    <button className="flex-1 px-3 py-1.5 bg-slate-700 hover:bg-slate-600 rounded text-xs font-semibold transition-colors">
                      Preview
                    </button>
                    <button className="flex-1 px-3 py-1.5 bg-blue-600 hover:bg-blue-700 rounded text-xs font-semibold transition-colors">
                      Export
                    </button>
                  </div>
                </div>
              );
            })}
            
            {deliverables.length === 0 && (
              <div className="text-center text-slate-500 py-8">
                No deliverables yet. Complete a study to generate outputs.
              </div>
            )}
          </div>
          
          {deliverables.length > 0 && (
            <div className="mt-4 pt-4 border-t border-slate-700">
              <button className="w-full py-2 bg-green-600 hover:bg-green-700 rounded font-semibold transition-colors">
                Export All ({deliverables.length} items)
              </button>
            </div>
          )}
        </div>
      </div>
    </div>
  );
};

export default ScientificPipeline;
